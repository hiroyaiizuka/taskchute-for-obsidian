// @ts-nocheck
import { getCurrentLocale } from '../i18n'

// Builds the default Daily Review template used when creating a new review note.
// It embeds dataviewjs that reads monthly task logs and renders:
// - Hourly average focus/energy chart
// - Comment list table
export function buildDefaultReviewTemplate(logDataPath: string): string {
  return getCurrentLocale() === 'ja'
    ? buildJapaneseTemplate(logDataPath)
    : buildEnglishTemplate(logDataPath)
}

function buildJapaneseTemplate(logDataPath: string): string {
  const LOG_LINE = `const LOG_DATA_PATH = ${JSON.stringify(logDataPath)}`
  const lines: string[] = []
  lines.push('---')
  lines.push('satisfaction: ')
  lines.push('---')
  lines.push('')
  lines.push('### é›†ä¸­ãƒ»å…ƒæ°—åº¦ã®æ¨ç§»')
  lines.push('```dataviewjs')
  lines.push('// ãƒ—ãƒ©ã‚°ã‚¤ãƒ³è¨­å®šã‹ã‚‰å—ã‘å–ã£ãŸãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¹ï¼ˆãƒ“ãƒ«ãƒ‰æ™‚ã«åŸ‹ã‚è¾¼ã¿ï¼‰')
  lines.push(LOG_LINE)
  lines.push('')
  lines.push('// ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰æ—¥ä»˜ã‚’å–å¾—')
  lines.push('// ãƒ•ã‚¡ã‚¤ãƒ«å: "Daily - YYYY-MM-DD"')
  lines.push('const fileName = dv.current().file.name')
  lines.push('')
  lines.push('// ã‚·ãƒ³ãƒ—ãƒ«ã«æ—¥ä»˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã ã‘ã‚’æ¢ã™')
  lines.push('const dateMatch = fileName.match(/\\d{4}-\\d{2}-\\d{2}/)')
  lines.push('')
  lines.push('if (!dateMatch) {')
  lines.push("  dv.paragraph('âŒ ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰æ—¥ä»˜ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«å: ' + fileName)")
  lines.push('  return')
  lines.push('}')
  lines.push('')
  lines.push('const currentDate = dateMatch[0] // YYYY-MM-DD')
  lines.push("const [year, month] = currentDate.split('-')")
  lines.push('const monthString = year + '-' + month')
  lines.push('')
  lines.push('// ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹')
  lines.push("const logPath = LOG_DATA_PATH + '/' + monthString + '-tasks.json'")
  lines.push('')
  lines.push('try {')
  lines.push('  const logFile = dv.app.vault.getAbstractFileByPath(logPath)')
  lines.push('  const content = logFile ? await dv.app.vault.read(logFile) : null')
  lines.push("  if (!content) throw new Error('Log file not found')")
  lines.push('')
  lines.push('  const monthlyLog = JSON.parse(content)')
  lines.push('  const dayTasks = monthlyLog.taskExecutions?.[currentDate] || []')
  lines.push('')
  lines.push('  // æ™‚é–“å¸¯åˆ¥ã«ãƒ‡ãƒ¼ã‚¿ã‚’é›†è¨ˆ')
  lines.push('  const hourlyData = new Array(24).fill(null).map(() => ({ focus: [], energy: [] }))')
  lines.push('')
  lines.push('  dayTasks.forEach(task => {')
  lines.push('    if (task.startTime && (task.focusLevel > 0 || task.energyLevel > 0)) {')
  lines.push("      const hourStr = task.startTime.split(':')[0]")
  lines.push("      const hour = parseInt(hourStr, 10)")
  lines.push('      if (hour >= 0 && hour < 24) {')
  lines.push('        if (task.focusLevel > 0) hourlyData[hour].focus.push(task.focusLevel)')
  lines.push('        if (task.energyLevel > 0) hourlyData[hour].energy.push(task.energyLevel)')
  lines.push('      }')
  lines.push('    }')
  lines.push('  })')
  lines.push('')
  lines.push('  const focusData = hourlyData.map(h => h.focus.length > 0')
  lines.push('    ? Math.round((h.focus.reduce((a,b) => a+b) / h.focus.length) * 10) / 10')
  lines.push('    : null)')
  lines.push('  const energyData = hourlyData.map(h => h.energy.length > 0')
  lines.push('    ? Math.round((h.energy.reduce((a,b) => a+b) / h.energy.length) * 10) / 10')
  lines.push('    : null)')
  lines.push('')
  lines.push("  const chartBlock = [")
  lines.push("    '````chart',")
  lines.push("    'type: bar',")
  lines.push("    'labels: [0æ™‚, 1æ™‚, 2æ™‚, 3æ™‚, 4æ™‚, 5æ™‚, 6æ™‚, 7æ™‚, 8æ™‚, 9æ™‚, 10æ™‚, 11æ™‚, 12æ™‚, 13æ™‚, 14æ™‚, 15æ™‚, 16æ™‚, 17æ™‚, 18æ™‚, 19æ™‚, 20æ™‚, 21æ™‚, 22æ™‚, 23æ™‚]',")
  lines.push("    'series:',")
  lines.push("    '  - title: é›†ä¸­åº¦',")
  lines.push("    '    data: [' + focusData.map(v => v ?? 0).join(', ') + ']',")
  lines.push("    '  - title: å…ƒæ°—åº¦',")
  lines.push("    '    data: [' + energyData.map(v => v ?? 0).join(', ') + ']',")
  lines.push("    'tension: 0',")
  lines.push("    'width: 80%',")
  lines.push("    'labelColors: false',")
  lines.push("    'fill: false',")
  lines.push("    'beginAtZero: false',")
  lines.push("    '````',")
  lines.push("  ].join('\\n');")
  lines.push('  dv.paragraph(chartBlock)')
  lines.push('} catch (e) {')
  lines.push("  dv.paragraph('âŒ ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚TaskChuteã®ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚')")
  lines.push('}')
  lines.push('')
  lines.push('```')
  lines.push('')
  lines.push('### ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§')
  lines.push('')
  lines.push('```dataviewjs')
  lines.push('// ãƒ—ãƒ©ã‚°ã‚¤ãƒ³è¨­å®šã‹ã‚‰å—ã‘å–ã£ãŸãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¹ï¼ˆãƒ“ãƒ«ãƒ‰æ™‚ã«åŸ‹ã‚è¾¼ã¿ï¼‰')
  lines.push(LOG_LINE)
  lines.push('')
  lines.push('// ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰æ—¥ä»˜ã‚’å–å¾—')
  lines.push('// ãƒ•ã‚¡ã‚¤ãƒ«å: "Daily - YYYY-MM-DD"')
  lines.push('const fileName = dv.current().file.name')
  lines.push('const dateMatch = fileName.match(/\\d{4}-\\d{2}-\\d{2}/)')
  lines.push('if (!dateMatch) {')
  lines.push("  dv.paragraph('âŒ ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰æ—¥ä»˜ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«å: ' + fileName)")
  lines.push('  return')
  lines.push('}')
  lines.push('')
  lines.push('const currentDate = dateMatch[0] // YYYY-MM-DD')
  lines.push("const [year, month] = currentDate.split('-')")
  lines.push('const monthString = year + '-' + month')
  lines.push('')
  lines.push('// ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹')
  lines.push("const logPath = LOG_DATA_PATH + '/' + monthString + '-tasks.json'")
  lines.push('')
  lines.push('try {')
  lines.push('  const logFile = dv.app.vault.getAbstractFileByPath(logPath)')
  lines.push('  const content = logFile ? await dv.app.vault.read(logFile) : null')
  lines.push("  if (!content) throw new Error('Log file not found')")
  lines.push('  const monthlyLog = JSON.parse(content)')
  lines.push('  const dayTasks = monthlyLog.taskExecutions?.[currentDate] || []')
  lines.push('')
  lines.push('  // ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚‹ã€ã‚‚ã—ãã¯ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãŒã‚ã‚‹ã‚¿ã‚¹ã‚¯ã®ã¿')
  lines.push('  const tasksWithComments = dayTasks')
  lines.push('    .filter(task => task.executionComment || task.focusLevel > 0 || task.energyLevel > 0)')
  lines.push('    .sort((a, b) => new Date(a.startTime) - new Date(b.startTime))')
  lines.push('')
  lines.push('  if (tasksWithComments.length > 0) {')
  lines.push("    const headers = ['ã‚¿ã‚¹ã‚¯å', 'å®Ÿè¡Œæ™‚é–“', 'æ‰€è¦æ™‚é–“', 'é›†ä¸­åº¦', 'å…ƒæ°—åº¦', 'ã‚³ãƒ¡ãƒ³ãƒˆ']")
  lines.push('    const tableData = tasksWithComments.map(task => {')
  lines.push('      const startTimeParts = task.startTime.split(\':\')')
  lines.push('      const stopTimeParts = task.stopTime.split(\':\')')
  lines.push('      const startTimeStr = startTimeParts[0] + ":" + startTimeParts[1]')
  lines.push('      const stopTimeStr = stopTimeParts[0] + ":" + stopTimeParts[1]')
  lines.push('      const durationMinutes = Math.round(task.duration / 60)')
  lines.push('      return [')
  lines.push('        task.taskTitle,')
  lines.push("        `${startTimeStr} - ${stopTimeStr}`,")
  lines.push("        `${durationMinutes}åˆ†`,")
  lines.push("        task.focusLevel > 0 ? 'â­'.repeat(task.focusLevel) : '-',")
  lines.push("        task.energyLevel > 0 ? 'â­'.repeat(task.energyLevel) : '-',")
  lines.push("        task.executionComment || '-' ")
  lines.push('      ]')
  lines.push('    })')
  lines.push('    dv.table(headers, tableData)')
  lines.push('  } else {')
  lines.push("    dv.paragraph('ğŸ“ ã‚³ãƒ¡ãƒ³ãƒˆä»˜ãã®ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚')")
  lines.push('  }')
  lines.push('} catch (e) {')
  lines.push("  dv.paragraph('âŒ ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚TaskChuteã®ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚')")
  lines.push('}')
  lines.push('')
  lines.push('```')
  lines.push('')
  lines.push('---')
  lines.push('')
  lines.push('### æŒ¯ã‚Šè¿”ã‚Šãƒ¡ãƒ¢')
  lines.push('')
  lines.push('- è‰¯ã‹ã£ãŸã“ã¨:')
  lines.push('- æ”¹å–„ã—ãŸã„ã“ã¨:')
  lines.push('- æ˜æ—¥ã¸ã®ã‚¢ã‚¤ãƒ‡ã‚¢:')
  lines.push('')
  lines.push('---')
  return lines.join('\n')
}

function buildEnglishTemplate(logDataPath: string): string {
  const LOG_LINE = `const LOG_DATA_PATH = ${JSON.stringify(logDataPath)}`
  const lines: string[] = []
  lines.push('---')
  lines.push('satisfaction: ')
  lines.push('---')
  lines.push('')
  lines.push('### Focus & energy trend')
  lines.push('```dataviewjs')
  lines.push('// Log data path injected from plugin settings')
  lines.push(LOG_LINE)
  lines.push('')
  lines.push('// Extract date from file name (Daily - YYYY-MM-DD)')
  lines.push('const fileName = dv.current().file.name')
  lines.push('const dateMatch = fileName.match(/\\d{4}-\\d{2}-\\d{2}/)')
  lines.push('if (!dateMatch) {')
  lines.push("  dv.paragraph('âŒ Unable to extract date from file name. File: ' + fileName)")
  lines.push('  return')
  lines.push('}')
  lines.push('')
  lines.push('const currentDate = dateMatch[0]')
  lines.push('const [year, month] = currentDate.split(\'-\')')
  lines.push("const monthString = `${year}-${month}`")
  lines.push("const logPath = `${LOG_DATA_PATH}/${monthString}-tasks.json`")
  lines.push('try {')
  lines.push('  const logFile = dv.app.vault.getAbstractFileByPath(logPath)')
  lines.push('  const content = logFile ? await dv.app.vault.read(logFile) : null')
  lines.push("  if (!content) throw new Error('Log file not found')")
  lines.push('  const monthlyLog = JSON.parse(content)')
  lines.push('  const dayTasks = monthlyLog.taskExecutions?.[currentDate] || []')
  lines.push('')
  lines.push('  const hourlyData = new Array(24).fill(null).map(() => ({ focus: [], energy: [] }))')
  lines.push('  dayTasks.forEach(task => {')
  lines.push('    if (task.startTime && (task.focusLevel > 0 || task.energyLevel > 0)) {')
  lines.push('      const hourStr = task.startTime.split(\':\')[0]')
  lines.push('      const hour = parseInt(hourStr, 10)')
  lines.push('      if (hour >= 0 && hour < 24) {')
  lines.push('        if (task.focusLevel > 0) hourlyData[hour].focus.push(task.focusLevel)')
  lines.push('        if (task.energyLevel > 0) hourlyData[hour].energy.push(task.energyLevel)')
  lines.push('      }')
  lines.push('    }')
  lines.push('  })')
  lines.push('')
  lines.push('  const focusData = hourlyData.map(h => h.focus.length > 0')
  lines.push('    ? Math.round((h.focus.reduce((a,b) => a+b) / h.focus.length) * 10) / 10')
  lines.push('    : null)')
  lines.push('  const energyData = hourlyData.map(h => h.energy.length > 0')
  lines.push('    ? Math.round((h.energy.reduce((a,b) => a+b) / h.energy.length) * 10) / 10')
  lines.push('    : null)')
  lines.push('')
  lines.push("  const labels = Array.from({ length: 24 }, (_, i) => `${i}h`)")
  lines.push("  const chartBlock = [")
  lines.push("    '````chart',")
  lines.push("    'type: bar',")
  lines.push("    'labels: [' + labels.join(', ') + ']',")
  lines.push("    'series:',")
  lines.push("    '  - title: Focus',")
  lines.push("    '    data: [' + focusData.map(v => v ?? 0).join(', ') + ']',")
  lines.push("    '  - title: Energy',")
  lines.push("    '    data: [' + energyData.map(v => v ?? 0).join(', ') + ']',")
  lines.push("    'tension: 0',")
  lines.push("    'width: 80%',")
  lines.push("    'labelColors: false',")
  lines.push("    'fill: false',")
  lines.push("    'beginAtZero: false',")
  lines.push("    '````',")
  lines.push("  ].join('\\n')")
  lines.push('  dv.paragraph(chartBlock)')
  lines.push('} catch (e) {')
  lines.push("  dv.paragraph('âŒ Unable to load data. Check that the TaskChute log file exists.')")
  lines.push('}')
  lines.push('')
  lines.push('```')
  lines.push('')
  lines.push('### Comments')
  lines.push('')
  lines.push('```dataviewjs')
  lines.push('// Load monthly log for the selected date')
  lines.push(LOG_LINE)
  lines.push('')
  lines.push('const fileName = dv.current().file.name')
  lines.push('const dateMatch = fileName.match(/\\d{4}-\\d{2}-\\d{2}/)')
  lines.push('if (!dateMatch) {')
  lines.push("  dv.paragraph('âŒ Unable to extract date from file name. File: ' + fileName)")
  lines.push('  return')
  lines.push('}')
  lines.push('')
  lines.push('const currentDate = dateMatch[0]')
  lines.push('const [year, month] = currentDate.split(\'-\')')
  lines.push("const monthString = `${year}-${month}`")
  lines.push("const logPath = `${LOG_DATA_PATH}/${monthString}-tasks.json`")
  lines.push('try {')
  lines.push('  const logFile = dv.app.vault.getAbstractFileByPath(logPath)')
  lines.push('  const content = logFile ? await dv.app.vault.read(logFile) : null')
  lines.push("  if (!content) throw new Error('Log file not found')")
  lines.push('  const monthlyLog = JSON.parse(content)')
  lines.push('  const dayTasks = monthlyLog.taskExecutions?.[currentDate] || []')
  lines.push('')
  lines.push('  const tasksWithComments = dayTasks')
  lines.push('    .filter(task => task.executionComment || task.focusLevel > 0 || task.energyLevel > 0)')
  lines.push('    .sort((a, b) => new Date(a.startTime) - new Date(b.startTime))')
  lines.push('  if (tasksWithComments.length > 0) {')
  lines.push("    const headers = ['Task', 'Execution time', 'Duration', 'Focus', 'Energy', 'Comment']")
  lines.push('    const tableData = tasksWithComments.map(task => {')
  lines.push("      const start = task.startTime.split(':')")
  lines.push("      const stop = task.stopTime.split(':')")
  lines.push("      const startStr = `${start[0]}:${start[1]}`")
  lines.push("      const stopStr = `${stop[0]}:${stop[1]}`")
  lines.push('      const durationMinutes = Math.round(task.duration / 60)')
  lines.push('      return [')
  lines.push('        task.taskTitle,')
  lines.push("        `${startStr} - ${stopStr}`,")
  lines.push("        `${durationMinutes} min`,")
  lines.push("        task.focusLevel > 0 ? 'â­'.repeat(task.focusLevel) : '-',")
  lines.push("        task.energyLevel > 0 ? 'â­'.repeat(task.energyLevel) : '-',")
  lines.push("        task.executionComment || '-' ")
  lines.push('      ]')
  lines.push('    })')
  lines.push('    dv.table(headers, tableData)')
  lines.push('  } else {')
  lines.push("    dv.paragraph('ğŸ“ No tasks with comments.')")
  lines.push('  }')
  lines.push('} catch (e) {')
  lines.push("  dv.paragraph('âŒ Unable to load data. Check that the TaskChute log file exists.')")
  lines.push('}')
  lines.push('')
  lines.push('```')
  lines.push('')
  lines.push('---')
  lines.push('')
  lines.push('### Reflection notes')
  lines.push('')
  lines.push('- Wins:')
  lines.push('- Improvements:')
  lines.push('- Ideas for tomorrow:')
  lines.push('')
  lines.push('---')
  return lines.join('\n')
}
